<!DOCTYPE html>
<html lang="en">
  <head>
  <title>A Sysdig + Kubernetes Adventure | NetApp Cloud Docs</title>
  <meta charset="utf-8">
  <meta property="og:title" content="A Sysdig + Kubernetes Adventure | NetApp Cloud Docs" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://docs.netapp.com/kubernetes-service/a-sysdig-kubernetes-adventure.html" />
	<meta property="og:description" content="Advanced Kubernetes troubleshooting with Sysdig." />
  <meta property="og:image" content="https://docs.netapp.com/kubernetes-service/images/logo-tophat-social.png" />
  <meta property="og:image:alt" content="NetApp Logo" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="format-detection" content="telephone=no">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge,chrome=1">
  <meta http-equiv="encoding" content="utf-8">
  <meta http-equiv="nss-type" content="Product Documentation"/>
  <meta http-equiv="nss-subtype" content="User Guide"/>
  
  <meta name="description" content="Advanced Kubernetes troubleshooting with Sysdig.">
  <meta name="keywords" content=" ">
  

  <!-- Icons -->
  <link rel="icon" href="/kubernetes-service/images/favicon.ico" type="image/x-icon">

  <!-- RSS Feed -->
  
  <link rel="alternate" type="application/rss+xml" title="NetApp Cloud Docs" href="/kubernetes-service/feed.xml">
  

  <!-- CSS Definitions: NetApp CSS should be defined after generic css -->

  <!-- Elastic Search -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/searchkit/0.10.0/theme.css">

  <!-- LUCI CSS Content -->
  <link rel="stylesheet" href="/kubernetes-service/common/css/esb.min.css">
  <link rel="stylesheet" href="/kubernetes-service/common/css/netapp-library.min.css">
  <link rel="stylesheet" href="/kubernetes-service/common/css/doc.css">
  <link rel="stylesheet" href="/kubernetes-service/common/css/doc-components.css">

  <link rel="stylesheet" href='/kubernetes-service/css/na-sidebar.css' type='text/css'>
  <link rel='stylesheet' href='/kubernetes-service/css/na-search.css' type='text/css'>
  <link rel='stylesheet' href='/kubernetes-service/css/clouddocs.css' type='text/css'>

  <!-- Font awesome seems to affect our GitHub Icon and generic "arrow box" for external links. -->
  <link rel="stylesheet" type="text/css" href="/kubernetes-service/css/font-awesome.min.css">
  <!-- <link rel="stylesheet" href="/kubernetes-service/css/customstyles.css"> -->
  <!-- Controls the shadow effect for search dropdown menu -->
  <link rel="stylesheet" href="/kubernetes-service/css/boxshadowproperties.css">

  <!-- NetApp CSS controls the technical content -->
  <link rel='stylesheet' href='/kubernetes-service/css/netapp.css' type='text/css'>

  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <!-- Used to import Promise for IE. Required for SearchKit -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.5/bluebird.min.js"></script>
  
    <script src='/kubernetes-service/js/na-search.js'></script>
  

  
  <link rel='stylesheet' href='/kubernetes-service/css/na-pagenav.css' type='text/css' id="pagenav-css">
  <script src='/kubernetes-service/js/na-pagenav.js'></script>
  

  <link rel='stylesheet' href='/kubernetes-service/css/prism.css' type='text/css'>
  <link rel='stylesheet' href='/kubernetes-service/css/prism-netapp.css' type='text/css'>

  <script src='/kubernetes-service/js/clouddocs.js'></script>
  <script src='/kubernetes-service/js/s_code_impl.js'></script>
  <script src='/kubernetes-service/js/jquery.navgoco.min.js'></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src='/kubernetes-service/js/toc.js'></script>
  <script src='/kubernetes-service/js/customscripts.js'></script>

  <script>
      $(document).ready(function() {
          // Initialize navgoco with default options
          $("#mysidebar").navgoco({
              caretHtml: '',
              accordion: true,
              openClass: 'active', // open
              save: false, // leave false or nav highlighting doesn't work right
              cookie: {
                  name: 'navgoco',
                  expires: false,
                  path: '/'
              },
              slide: {
                  duration: 400,
                  easing: 'swing'
              }
          });

          $("#collapseAll").click(function(e) {
              e.preventDefault();
              $("#mysidebar").navgoco('toggle', false);
          });

          $("#expandAll").click(function(e) {
              e.preventDefault();
              $("#mysidebar").navgoco('toggle', true);
          });

      });

  </script>
  <script>
      $(document).ready(function() {
          $("#tg-sb-link").click(function() {
              $("#tg-sb-sidebar").toggle();
              $("#tg-sb-content").toggleClass('col-md-9');
              $("#tg-sb-content").toggleClass('col-md-12');
              $("#tg-sb-icon").toggleClass('fa-toggle-on');
              $("#tg-sb-icon").toggleClass('fa-toggle-off');
          });
      });
  </script>

  <!-- Controls the i18n Browser Redirection -->
  <script>
    var siteLocales = [];
    
      siteLocales.push("us-en");
    

    standardizeUrl(siteLocales, "clouddocs.netapp.com", "https://docs.netapp.com");
  </script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-81697994-3"></script>
  <script>
  if (document.location.hostname === "docs.netapp.com") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-81697994-3');
  }
  </script>
</head>


  <body class="n-doc__component-detail">
    <a href="#n-main-content" class="visually-hidden">Skip to main content</a>
<div class="n-off-canvas-menu">
  <div class="n-off-canvas-menu__menu">
    <div class="n-off-canvas-menu__menu-inner">
      <div class="n-off-canvas-menu__property-title">NetApp Cloud Docs</div>
      <ul class="n-off-canvas-menu__property-navigation-list">
        <li class="n-off-canvas-menu__property-navigation-list-item ">
          <a href="https://docs.netapp.com/us-en/" class="n-off-canvas-menu__property-navigation-link">
            Home
          </a>
          <div class="n-off-canvas-menu__child-menu">
            <ul class="n-menu__list">

            </ul>
          </div>
        </li>
      </ul>

      <ul class="n-off-canvas-menu__global-navigation-list">
         <li class="n-off-canvas-menu__global-navigation-list-header">More From NetApp</li>
         <li class="n-off-canvas-menu__global-navigation-list-item"><a href="#" class="n-off-canvas-menu__global-navigation-link">Netapp.com</a></li>
      </ul>
    </div>
  </div>
</div>

    <div class="n-off-canvas-menu__content-wrap">
      <!-- Header -->
      <header>
  <!-- Top Hat -->
  <div class="n-top-hat">
    <div class="n-container">
      <div class="n-top-hat__cross-property-nav">
        <ul class="n-top-hat__list">
            <li class="n-top-hat__list-item">
              <a href="http://www.netapp.com" class="n-top-hat__link">NetApp.com</a>
            </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Property Bar -->
  <div class="n-property-bar n-property-bar--v3">
    <div class="n-property-bar__inner-wrap">
      <div class="n-property-bar__menu-toggle">
        <a href="#" class="n-property-bar__menu-toggle-link"><span class="n-property-bar__menu-toggle-text">Menu</span><svg class="n-icon-bars n-property-bar__menu-toggle-icon" aria-labelledby="title">
          <title>bars</title>
          <use xlink:href="/kubernetes-service/common/svg/sprite.svg#bars"></use>
        </svg></a>
      </div>
      <div class="n-property-bar__property-mark n-property-bar__property-mark--has-property-name">
        <a class="n-property-bar__property-link" href="https://docs.netapp.com/us-en/">
          <div class="n-property-bar__logo">
            <svg class="n-icon-netapp-mark n-property-bar__netapp-mark-icon" aria-labelledby="title">
              <title>netapp-mark</title>
              <use xlink:href="/kubernetes-service/common/svg/sprite.svg#netapp-mark"></use>
            </svg>
            <svg class="n-property-bar__logo-svg" aria-labelledby="title">
              <title>NetApp</title>
              <use xlink:href="/kubernetes-service/common/svg/sprite.svg#netapp-logo"></use>
            </svg>
          </div>
          <h2 class="n-property-bar__property-name">Cloud Docs</h2>
        </a>
      </div>

      
      <div id="search-demo-container" class="n-property-bar__search">
        <div id="react-search"></div>
      </div>
      

      <div id="ie-i18n-menu" class="n-property-bar__utils">
        <ul class="n-property-navigation-bar__utils-list">
          <li class="n-property-navigation-bar__utils-list-item ie-i18n-container">
            <a href="#" class="n-property-navigation-bar__utils-link n-property-navigation-bar__nav-link n-property-navigation-bar__language-selector-toggle ie-i18n-link" data-menu-id="n-property-navigation-bar__menu--language-selector">
              <span class="ie-i18n-lang">English</span>
              <svg class="ie-i18n-icon-container" class="n-property-bar__logo-svg" aria-labelledby="title">
                <title>globe</title>
                <use xlink:href="/kubernetes-service/common/svg/sprite.svg#globe" class="n-icon-globe n-globe__icon"></use>
              </svg>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="n-property-bar__menus">
      <div id="n-property-navigation-bar__menu--language-selector" class="n-menu n-menu--v3">
        <div class="n-language-selector-menu">
          <div class="n-language-selector-menu__header">
            <span class="n-language-selector-menu__title">Select Your Language</span>
          </div>
          <ul class="n-menu__list">
            <li class="n-menu__list-column">
              <ul class="n-menu__list">


                
                <li class="n-menu__list-item n-menu__list-item--level-1">
                  <a href="/kubernetes-service/us-en/" class="n-menu__header-text">English</a>
                </li>
                
              </ul>
            </li>
          </ul>
          <div class="menu__footer">
            <p>Current Language: English
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>


      <!-- Content -->
      <main role="main" id="n-main-content" class="n-main-content">
        <div class="n-container">
  <div class="n-row">
    <div class="n-doc n-doc__component-list">
      <!-- Sidebar Column -->
      
      <div class="col-md-3" >
          

<ul id="mysidebar" class="nav">
  

  
    <li><a href="index.html">NKS Docs</a></li>
  

  
    <!-- Check Container -->
    <li class="subfolders">
      <a href="#">Setup - Find Credentials</a>
      <ul>
        

  
    <li><a href="create-auth-credentials-on-aws.html">Find AWS Credentials</a></li>
  

  
    <li><a href="create-auth-credentials-on-azure.html">Find Azure Credentials</a></li>
  

  
    <li><a href="create-auth-credentials-on-gce.html">Find GCE Credentials</a></li>
  

  
    <li><a href="create-auth-credentials-on-gke.html">Find GKE Credentials</a></li>
  

  
    <li><a href="find-aws-credentials-for-cvs.html">Find AWS Credentials for CVS</a></li>
  


      </ul>
    </li>
  

  
    <!-- Check Container -->
    <li class="subfolders">
      <a href="#">API</a>
      <ul>
        

  
    <li><a href="api-basics.html">API Basics</a></li>
  

  
    <li><a href="api-organizations.html">Organizations</a></li>
  

  
    <li><a href="api-workspaces.html">Workspaces</a></li>
  

  
    <li><a href="api-teams.html">Teams</a></li>
  

  
    <li><a href="api-members.html">Members</a></li>
  

  
    <li><a href="api-user.html">User</a></li>
  

  
    <li><a href="api-keysets.html">Keysets</a></li>
  

  
    <li><a href="api-clusters.html">Clusters</a></li>
  

  
    <li><a href="api-nodes.html">Nodes</a></li>
  

  
    <li><a href="api-nodepools.html">Nodepools</a></li>
  

  
    <li><a href="api-federations.html">Federations</a></li>
  

  
    <li><a href="api-trusted-charts.html">Trusted Charts</a></li>
  


      </ul>
    </li>
  

  
    <li><a href="nks-requirements.html">Requirements</a></li>
  

  
    <li><a href="whitelist-ports-and-ip-addresses.html">Whitelist Ports and IP Addresses</a></li>
  

  
    <li><a href="intro-to-terraform-on-nks.html">Terraform on NKS</a></li>
  

  
    <li><a href="install-kubectl-to-control-a-kubernetes-cluster.html">Install Kubectl</a></li>
  

  
    <li><a href="using-the-kubernetes-cloud-backup.html">Using the Kubernetes Cloud Backup</a></li>
  

  
    <li><a href="managing-ingresses-on-kubernetes.html">Managing Ingresses on Kubernetes</a></li>
  

  
    <li><a href="news.html">What's New</a></li>
  


</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

      </div>
      

      <div class="n-doc__component-detail-content n-doc__component-detail-content--show-code">
        <!-- Begin of page container -->
        <article class="page-content">
          

<div class="n-doc__component-detail-heading-wrap">
  <h1 class="n-doc__component-detail-heading">A Sysdig + Kubernetes Adventure
    <span>
      
        <a target="_blank" href="https://github.com/NetAppDocs/kubernetes-service/blob/master/a-sysdig-kubernetes-adventure.adoc" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit on GitHub</a>
        <a target="_blank" href="https://github.com/NetAppDocs/kubernetes-service/issues/new?body=Page%3A%20[A Sysdig + Kubernetes Adventure](https://docs.netapp.com/us-en/kubernetes-service/a-sysdig-kubernetes-adventure.html)" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Request doc changes</a>
      
    </span>
  </h1>
</div>

<p class="page-details">

<time datetime="2019-01-23 19:01:56 +0000">01/23/2019</time>


<span>Contributors
  
  <a target="_blank" href="https://github.com/ebarcott">
    <img  class="avatar avatar-small"
          alt="ebarcott"
          width="20" height="20"
          src="https://avatars3.githubusercontent.com/u/44878916?v=4"
          style="border-radius: 50%;"/>
  </a>
  
</span>

</p>

<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We <a href="https://sysdig.com/digging-into-kubernetes-with-sysdig/">recently released</a> Kubernetes support for our open source visibility and troubleshooting tool,  <a href="http://www.sysdig.org/">sysdig</a>, and the feedback from the community has been overwhelmingly positive – so today I want to continue the technical discussion on Kubernetes by going through a few examples of advanced Kubernetes troubleshooting. In particular, I’m going to focus on Kubernetes <em>services</em>.</p>
</div>
<div class="paragraph">
<p>To refresh your memory, a service is a Kubernetes abstraction that works by providing a convenient and single entry point to access a group of Kubernetes pods. In other words, a service can be thought of as a dynamic load balancer for a set of pods (and the containers living inside them), automatically managed by the framework itself.</p>
</div>
<div class="paragraph">
<p>I absolutely love services because they represent a very clean and consistent pattern that allows developers to write applications more efficiently, without having to worry about hand-crafted and bug-prone service discovery mechanisms. I am also surprised by how well they work – so much so that I decided to study them with sysdig!</p>
</div>
<div class="paragraph">
<p>In this two-part series, we’ll first explore how services work from a technical point of view, to see how all the magic is implemented under the hood. In the second part, we’ll do a similar kind of exploration, but in faulty environments, trying to find the cause of various issues.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-a-kubernetes-service">Setting up a Kubernetes service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I am a firm believer that in order to be effective at troubleshooting when anomalous conditions happen, one needs to be well aware of how the application works in a healthy environment: this way, by understanding the normal behavior of the system, spotting differences is much easier. Let’s start by studying how a service behaves in a fully working environment.</p>
</div>
<div class="paragraph">
<p>I’m going to make the setup as simple as possible: it consists of two nginx pods, serving the standard index.html page that comes with nginx, and a single service that automatically balances the incoming traffic between them.</p>
</div>
<div class="paragraph">
<p>Creating the pods is as simple as running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ kubectl run my-nginx --image=nginx --replicas=2 --port=80
CONTROLLER   CONTAINER(S)   IMAGE(S)   SELECTOR       REPLICAS
my-nginx     my-nginx       nginx      run=my-nginx   2</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ kubectl expose rc my-nginx --port=8080 --target-port=80
NAME       LABELS         SELECTOR       IP(S)     PORT(S)
my-nginx   run=my-nginx   run=my-nginx             8080/TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>This last command creates a service, named my-nginx, that exposes a virtual IP address through which other pods in the cluster are transparently able to access the two backend nginx pods, using port 8080. This IP never changes for the entire lifespan of the service, which makes it incredibly useful for service discovery, because even if all my pods die and are rescheduled somewhere else, the entry point never changes and will not break the other parts of the application. I can get the virtual IP address with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ kubectl get services
NAME         LABELS                                    SELECTOR       IP(S)       PORT(S)
my-nginx     run=my-nginx                              run=my-nginx   10.0.0.142   8080/TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>But, since IP addresses are notably hard to remember, I prefer to use nice DNS names for my services, and Kubernetes has a very cool DNS extension that, once installed, runs a local DNS server inside the cluster and automatically translates DNS requests with the service name in it to the proper virtual IP address. Absolutely magic!</p>
</div>
<div class="paragraph">
<p>Now that the infrastructure is up and running, before jumping into the low level details let’s run a pod with a simple Ubuntu container that doesn’t run anything other than a shell. I am going use this pod as a main access point to interact with my application from inside the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ kubectl run -i --tty client --image=tutum/curl
Waiting for pod to be scheduled
Waiting for pod default/client-wd32o to be running, status is Pending, pod ready: false
Waiting for pod default/client-wd32o to be running, status is Running, pod ready: false
root@ubuntu:/#</code></pre>
</div>
</div>
<div class="paragraph">
<p>And once I’m in the shell I can finally interact with my service, using the DNS extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>root@ubuntu:/# curl my-nginx.default.cluster.local:8080

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&amp;lt;style&amp;gt;
...&amp;lt;/style&amp;gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="digging-into-services">Digging into services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the environment is set up, I’m going to take a sysdig capture while curl runs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ sudo sysdig -w trace.scap</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the capture has been taken, I am going to use sysdig to read it, visualizing only the network-related events:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ sysdig -r trace.scap -A fd.type=ipv4 or fd.type=ipv6</code></pre>
</div>
</div>
<div class="paragraph">
<p>To start, I can see curl connecting to the DNS server, because obviously it needs to resolve the IP address for my-nginx.default.cluster.local:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43340 15:40:58.352366394 3 curl (51152) &amp;gt; connect fd=3(&amp;lt;4&amp;gt;)
43341 15:40:58.352375784 3 curl (51152) &amp;lt; connect res=0 tuple=172.17.0.25:49950-&amp;gt;172.16.189.136:53</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS server that serves this request is, as predicted, the skydns process, which is part of the Kubernetes DNS extension and runs on my local machine (IP 172.16.189.136). We can see the binary data that is sent by curl, corresponding to a typical DNS request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43373 15:40:58.352568546 2 skydns (40700) &amp;gt; recvmsg fd=6(&amp;lt;3t&amp;gt;:::53)
43374 15:40:58.352570915 2 skydns (40700) &amp;lt; recvmsg res=48 size=48 data=
	0x0000: 0942 0100 0001 0000 0000 0000 086d 792d  .B...........my-
	0x0010: 6e67 696e 7807 6465 6661 756c 7407 636c  nginx.default.cl
	0x0020: 7573 7465 7205 6c6f 6361 6c00 001c 0001  uster.local.....
 tuple=::ffff:172.17.0.25:49950-&amp;gt;::ffff:172.17.0.25:domain</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is <strong>where the magic starts happening</strong>: the skydns process converts the DNS request to an HTTP request to etcd (port 4001) for the key “skydns/local/cluster/default/my-nginx”, to which etcd replies with the key value (in JSON), containing, among other things, the IP address of the service, 10.0.0.142, which is then returned to curl under the form of a DNS response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43405 15:40:58.353069087 2 skydns (40714) &amp;gt; write fd=3(&amp;lt;4t&amp;gt;127.0.0.1:37238-&amp;gt;127.0.0.1:4001) size=182
43406 15:40:58.353099313 2 skydns (40714) &amp;lt; write res=182 data=
GET /v2/keys/skydns/local/cluster/default/my-nginx?quorum=false&amp;recursive=true&amp;sorted=false HTTP/1.1
Host: 127.0.0.1:4001
User-Agent: Go 1.1 package http
Accept-Encoding: gzip

43468 15:40:58.353384452 1 skydns (48700) &amp;gt; read fd=3(&amp;lt;4t&amp;gt;127.0.0.1:37238-&amp;gt;127.0.0.1:4001) size=4096
43469 15:40:58.353388313 1 skydns (48700) &amp;lt; read res=406 data=
HTTP/1.1 200 OK
Content-Type: application/json
X-Etcd-Cluster-Id: f68652439e3f8f2a
X-Etcd-Index: 166
X-Raft-Index: 1205
X-Raft-Term: 2
Date: Thu, 05 Nov 2015 23:40:58 GMT
Content-Length: 205

{"action":"get","node":{"key":"/skydns/local/cluster/default/my-nginx","value":"{\"host\":\"10.0.0.142\",\"priority\":10,\"weight\":10,\"ttl\":30,\"targetstrip\":0}","modifiedIndex":70,"createdIndex":70}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that curl got the IP address of the service from skydns, it can connect to it on port 8080 and send the HTTP request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43645 15:40:58.356720087 2 curl (51151) &amp;lt; connect res=-115(EINPROGRESS) tuple=172.17.0.25:50950-&amp;gt;10.0.0.142:http-alt
43763 15:40:58.357571155 2 curl (51151) &amp;gt; sendto fd=3(&amp;lt;4t&amp;gt;172.17.0.25:50950-&amp;gt;10.0.0.142:8080) size=99 tuple=NULL
43772 15:40:58.357612691 2 curl (51151) &amp;lt; sendto res=99 data=
GET / HTTP/1.1
User-Agent: curl/7.35.0
Host: my-nginx.default.cluster.local:8080
Accept: */*</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this is where things get a bit odd. As you can see next, the hyperkube process seems to intercept the connection that curl sent, and read the original HTTP request from it. In particular, notice how the source port seems to be in both cases 50950, but the destination IP address and port seem to have magically changed from 10.0.0.142:8080 to 172.17.42.1:39551:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43795 15:40:58.357730454 2 hyperkube (39579) &amp;gt; read fd=10(&amp;lt;4t&amp;gt;172.17.0.25:50950-&amp;gt;172.17.42.1:39551) size=32768
43796 15:40:58.357733201 2 hyperkube (39579) &amp;lt; read res=99 data=
GET / HTTP/1.1
User-Agent: curl/7.35.0
Host: my-nginx.default.cluster.local:8080
Accept: */*</code></pre>
</div>
</div>
<div class="paragraph">
<p>The trick used by Kubernetes here is to leverage the Linux kernel Netfilter capabilities to create a virtual IP that never leaves the host. As you can read from my iptables configuration below, every time someone tries to connect to 10.0.0.142:8080, it will be redirected to 172.16.189.136:39551, where the Kubernetes proxy server (shown as hyperkube in my sysdig trace file) will get the request and will properly route it to one of the backend nginx pods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>gianluca@sid:~$ sudo iptables -t nat -L
...
Chain KUBE-PORTALS-CONTAINER (1 references)
target     prot opt source               destination
...
REDIRECT   tcp  --  anywhere             10.0.0.142           /* default/my-nginx: */ tcp dpt:http-alt redir ports **39551**
...

Chain KUBE-PORTALS-HOST (1 references)
target     prot opt source               destination
...
DNAT       tcp  --  anywhere             10.0.0.142           /* default/my-nginx: */ tcp dpt:http-alt to:172.16.189.136:**39551**
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the proxy is done reading the HTTP request, it can normally forward it to one of the nginx pods (172.17.0.24 in this case), where the nginx process can serve the transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>43798 15:40:58.357735649 2 hyperkube (39579) &amp;gt; write fd=11(&amp;lt;4t&amp;gt;172.17.42.1:38546-&amp;gt;172.17.0.24:80) size=99
43799 15:40:58.357755452 2 hyperkube (39579) &amp;lt; write res=99 data=
GET / HTTP/1.1
User-Agent: curl/7.35.0
Host: my-nginx.default.cluster.local:8080
Accept: */*

43907 15:40:58.358733815 2 nginx (40473) &amp;gt; recvfrom fd=3(&amp;lt;4t&amp;gt;172.17.42.1:38546-&amp;gt;172.17.0.24:80) size=1024
43908 15:40:58.358735877 2 nginx (40473) &amp;lt; recvfrom res=99 data=
GET / HTTP/1.1
User-Agent: curl/7.35.0
Host: my-nginx.default.cluster.local:8080
Accept: */*</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is how Kubernetes services are implemented! Notice that there might be different behaviors depending on the specific Kubernetes configuration and version, but this represents a very common behavior.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusions">Conclusions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Today we explored a pretty advanced use case, and we went a long way understanding one of the trickiest parts of Kubernetes, all with sysdig. If we pair this with the Kubernetes support described in <a href="https://sysdig.com/digging-into-kubernetes-with-sysdig/">our previous blog post</a>, we can immediately see how sysdig can be helpful in a variety of situations, from basic Kubernetes exploration with csysdig’s views to advanced process troubleshooting with sysdig’s system and Kubernetes filters. And if you want to keep an eye on your whole multi-node Kubernetes cluster, check out Sysdig Cloud!</p>
</div>
<div class="paragraph">
<p>In part two, we’ll leverage all the knowledge gained here to troubleshoot faulty environments where Kubernetes services are misbehaving. Stay tuned!</p>
</div>
</div>
</div>

        </article>
        <!-- Page Container -->
      </div>

      
      <div class="page-nav-container">
        <nav class="page-nav-fixed">
          <div class="page-nav-title">On this page:</div>
          <ul class="page-nav-inner" id="page-menu"></ul>
        </nav>
      </div>
      

    </div>
  </div>
</div>

      </main>

      <!-- Footer -->
      
      <footer class="n-footer n-footer--v1" style="border-top: solid 10px #DFDFDF;">
        <div class="n-footer__bottom">
          <div class="n-container">
            <div class="n-footer__bottom-left">
              <div class="n-footer__copyright">
                  <a href="//www.netapp.com/us/legal/copyright.aspx" class="n-footer__copyright-link">© 2019 NetApp, Inc.</a>
              </div>
              <div class="n-footer__copyright">
                <a href="https://library.netapp.com/ecm/ecm_download_file/ECMLP2848669" class="n-footer__copyright-link">Notice</a>
              </div>
              <div class="n-footer__copyright">
                <a href="//www.netapp.com/us/legal/index.aspx" class="n-footer__copyright-link">Legal</a>
              </div>
              <div class="n-footer__social-links n-footer__copyright">
                <ul class="n-footer__social-link-list">
                  <li class="n-footer__social-link-list-item">
                    <a class="n-footer__social-link" data-ntap-social="follow-blog" href="http://blog.netapp.com" target="_blank" title="blog" alt="blog">
                      <span class="n-footer__social-link-text">blog</span>
                      <svg class="n-icon-blog n-footer__social-link-icon" aria-labelledby="title">
                        <title>blog@</title>
                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/kubernetes-service/common/svg/sprite.svg#blog"></use>
                      </svg>
                    </a>
                  </li>
                  <li class="n-footer__social-link-list-item">
                    <a class="n-footer__social-link" data-ntap-social="follow-community" href="http://community.netapp.com/" target="_blank" title="community" alt="community">
                      <span class="n-footer__social-link-text">community</span>
                      <svg class="n-icon-twitter n-footer__social-link-icon" aria-labelledby="title">
                        <title>community@</title>
                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/kubernetes-service/common/svg/sprite.svg#comments"></use>
                      </svg>
                    </a>
                  </li>

                  <li class="n-footer__social-link-list-item">
                    <a class="n-footer__social-link" data-ntap-social="follow-twitter" href="https://twitter.com/netappdoc" target="_blank" title="twitter" alt="twitter">
                      <span class="n-footer__social-link-text">twitter</span>
                      <svg class="n-icon-twitter n-footer__social-link-icon" aria-labelledby="title">
                        <title>twitter@</title>
                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/kubernetes-service/common/svg/sprite.svg#twitter"></use>
                      </svg>
                    </a>
                  </li>
                  <li class="n-footer__social-link-list-item">
                    <a class="n-footer__social-link" data-ntap-social="follow-youtube" href="https://www.youtube.com/user/NetAppTechCommTV/" target="_blank" title="youtube" alt="youtube">
                      <span class="n-footer__social-link-text">youtube</span>
                      <svg class="n-icon-youtube n-footer__social-link-icon" aria-labelledby="title">
                        <title>youtube@</title>
                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/kubernetes-service/common/svg/sprite.svg#youtube"></use>
                      </svg>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="n-footer__bottom-right">
              <div class="n-footer__copyright">
                <a href="https://docs.netapp.com/us-en/contribute/" class="n-footer__copyright-link">Contribute</a>
              </div>
              <div class="n-footer__copyright">
                <a target="_self" class="n-footer__copyright-link" href="javascript:netapp_mailto()">Email your feedback</a>
              </div>
            </div>
          </div>
        </div>
      </footer>

    </div>

    <script src="/kubernetes-service/common/js/components.js"></script>
    <script src="/kubernetes-service/common/js/doc-components.js"></script>

    <!-- Elasticsearch JS -->
    <script type="text/javascript" src='/kubernetes-service/js/bundle.js'></script>

    <!-- Syntax Highlighting -->
    <script type="text/javascript" src='/kubernetes-service/js/prism.js'></script>
    <script type="text/javascript" src='/kubernetes-service/js/prism-curl.js'></script>

  </body>

  
</html>
